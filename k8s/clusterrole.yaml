apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: mcp-homelab
  labels:
    app.kubernetes.io/name: mcp-homelab
rules:
  # Core resources - read only
  - apiGroups: [""]
    resources:
      - pods
      - pods/log
      - services
      - nodes
      - events
      - configmaps
      - persistentvolumeclaims
      - namespaces
    verbs: ["get", "list", "watch"]

  # Workloads - read only
  - apiGroups: ["apps"]
    resources:
      - deployments
      - statefulsets
      - daemonsets
    verbs: ["get", "list", "watch"]

  # Deployments - patch for rollout restart (whitelisted in code)
  - apiGroups: ["apps"]
    resources:
      - deployments
    verbs: ["patch"]

  # Batch - read and create jobs
  - apiGroups: ["batch"]
    resources:
      - jobs
      - cronjobs
    verbs: ["get", "list", "watch", "create"]

  # Networking
  - apiGroups: ["networking.k8s.io"]
    resources:
      - ingresses
    verbs: ["get", "list", "watch"]

  # Flux CD
  - apiGroups: ["kustomize.toolkit.fluxcd.io"]
    resources:
      - kustomizations
    verbs: ["get", "list", "watch", "patch"]

  - apiGroups: ["helm.toolkit.fluxcd.io"]
    resources:
      - helmreleases
    verbs: ["get", "list", "watch", "patch"]

  - apiGroups: ["source.toolkit.fluxcd.io"]
    resources:
      - gitrepositories
      - helmrepositories
      - helmcharts
    verbs: ["get", "list", "watch"]

  # Cert-manager
  - apiGroups: ["cert-manager.io"]
    resources:
      - certificates
      - certificaterequests
      - challenges
      - orders
    verbs: ["get", "list", "watch"]

  # External Secrets
  - apiGroups: ["external-secrets.io"]
    resources:
      - externalsecrets
      - clustersecretstores
      - secretstores
    verbs: ["get", "list", "watch", "patch"]

  # Tailscale
  - apiGroups: ["tailscale.com"]
    resources:
      - connectors
    verbs: ["get", "list", "watch"]

  # Metrics
  - apiGroups: ["metrics.k8s.io"]
    resources:
      - nodes
      - pods
    verbs: ["get", "list"]
